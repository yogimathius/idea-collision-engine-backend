name: Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (e.g., v1.0.0, v2.1.3)

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Create GitHub Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release-version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for changelog

      - name: Get version from tag
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          echo "## ðŸŽ‰ Release ${{ steps.get-version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ“… Release Date: $(date -u '+%Y-%m-%d')" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Get commits since last tag
          echo "### ðŸ“ Changes:" >> CHANGELOG.md
          git log --oneline --pretty=format:"- %s" $PREVIOUS_TAG..${{ github.sha }} >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Get contributors
          echo "" >> CHANGELOG.md
          echo "### ðŸ‘¥ Contributors:" >> CHANGELOG.md
          git log --pretty=format:"- %an" $PREVIOUS_TAG..${{ github.sha }} | sort | uniq >> CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get-version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.get-version.outputs.version, '-') }}
          generate_release_notes: true

  # Build and test everything
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [amd64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64 # Windows ARM64 builds are complex
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: collision_engine_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Run frontend tests
        run: pnpm run test:run

      - name: Install Go dependencies
        run: go mod download

      - name: Run Go tests
        if: matrix.os == 'ubuntu-latest' # Only run tests on Ubuntu (requires services)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/collision_engine_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
          OPENAI_API_KEY: test-key
          STRIPE_SECRET_KEY: test-key
        run: go test -v ./...

      - name: Build binaries
        env:
          GOOS: ${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'darwin' }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          # Build server
          go build -a -installsuffix cgo -ldflags="-w -s" \
            -o idea-collision-engine-${{ env.GOOS }}-${{ matrix.arch }}${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
            cmd/server/main.go
          
          # Build migration tool
          go build -a -installsuffix cgo -ldflags="-w -s" \
            -o migrate-${{ env.GOOS }}-${{ matrix.arch }}${{ matrix.os == 'windows-latest' && '.exe' || '' }} \
            cmd/migrate/main.go

      - name: Upload release binaries
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.release-version }}
          files: |
            idea-collision-engine-*
            migrate-*

  # Build and push Docker images
  docker-release:
    name: Docker Release
    runs-on: ubuntu-latest
    needs: [create-release, build-and-test]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Generate release artifacts
  release-artifacts:
    name: Generate Release Artifacts
    runs-on: ubuntu-latest
    needs: [create-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Create deployment package
        run: |
          mkdir -p release-artifacts
          
          # Copy essential files
          cp -r dist release-artifacts/
          cp -r docs release-artifacts/
          cp -r migrations release-artifacts/
          cp docker-compose.yml release-artifacts/
          cp Dockerfile release-artifacts/
          cp deploy.sh release-artifacts/
          cp README.md release-artifacts/
          
          # Create deployment guide
          cat > release-artifacts/DEPLOYMENT.md << 'EOF'
          # ðŸš€ Deployment Guide
          
          ## Quick Start
          1. Extract this release package
          2. Copy `.env.production.example` to `.env.production`
          3. Configure your environment variables
          4. Run: `./deploy.sh`
          
          ## What's Included
          - Frontend build (`dist/`)
          - API documentation (`docs/`)
          - Database migrations (`migrations/`)
          - Docker configuration
          - Deployment scripts
          
          ## Requirements
          - Docker & Docker Compose
          - PostgreSQL 16+
          - Redis 7+
          
          ## Support
          - Documentation: `/docs/`
          - Health Check: `/health`
          - API Docs: `/docs/`
          EOF
          
          # Create environment template
          cat > release-artifacts/.env.production.example << 'EOF'
          # Production Environment Configuration
          NODE_ENV=production
          PORT=8080
          
          # Database
          DATABASE_URL=postgres://user:password@localhost:5432/collision_engine
          
          # Cache
          REDIS_URL=redis://localhost:6379
          
          # Security
          JWT_SECRET=your-super-secure-jwt-secret-change-this
          
          # External Services
          OPENAI_API_KEY=your-openai-api-key
          STRIPE_SECRET_KEY=your-stripe-secret-key
          
          # CORS
          CORS_ORIGINS=https://yourdomain.com
          EOF
          
          # Create archive
          tar -czf idea-collision-engine-${{ needs.create-release.outputs.release-version }}.tar.gz -C release-artifacts .

      - name: Upload deployment package
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release.outputs.release-version }}
          files: |
            idea-collision-engine-${{ needs.create-release.outputs.release-version }}.tar.gz

  # Post-release tasks
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [create-release, build-and-test, docker-release, release-artifacts]
    if: always()
    steps:
      - name: Notify success
        if: ${{ needs.create-release.result == 'success' && needs.build-and-test.result == 'success' && needs.docker-release.result == 'success' }}
        run: |
          echo "ðŸŽ‰ Release ${{ needs.create-release.outputs.release-version }} completed successfully!"
          echo "ðŸ“¦ Docker images pushed to registry"
          echo "ðŸ“ Release artifacts uploaded"
          echo "ðŸ”— GitHub release created"

      - name: Notify failure
        if: ${{ needs.create-release.result == 'failure' || needs.build-and-test.result == 'failure' || needs.docker-release.result == 'failure' }}
        run: |
          echo "âŒ Release ${{ needs.create-release.outputs.release-version }} failed!"
          echo "Please check the workflow logs for details."
          exit 1